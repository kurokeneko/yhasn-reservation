<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>YHASN施設予約管理</title>
  <!-- 管理者用予約入力画面への遷移ボタン -->
<div style="text-align: right; margin-bottom: 20px;">
  <button onclick="location.href='admin-reserve.html'" style="background-color: #00796b; color: white; padding: 10px 16px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer;">
    管理者用予約フォームへ
  </button>
</div>
  <style>
body {
  font-family: 'Noto Sans JP', sans-serif;
  margin: 30px;
  background: linear-gradient(to bottom, #e0f7fa, #80deea);
  min-height: 100vh;
}
   h1 {
  color: #0277bd;
  text-align: center;
  font-size: 28px;
  margin-bottom: 20px;
}
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 20px;
  background-color: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border-radius: 8px;
  overflow: hidden;
}
th, td {
  border: 1px solid #ddd;
  padding: 12px;
  text-align: center;
  font-size: 14px;
}

#scheduleTable table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: #ffffff;
  margin-top: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border-radius: 8px;
  overflow: hidden;
}
#scheduleTable th, #scheduleTable td {
  border: 1px solid #ddd;
  padding: 12px;
  height: 60px;
  text-align: center;
  vertical-align: middle;
  font-size: 14px;
}
   button {
  padding: 6px 12px;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}

/* 通常の青ボタン（例：複数選択ボタン） */
button:not(.cancel-btn):not(#cancelSelectedBtn) {
  background-color: #0288d1;
}
button:not(.cancel-btn):not(#cancelSelectedBtn):hover {
  background-color: #0277bd;
}

/* 通常のキャンセルボタン */
button.cancel-btn {
  background-color: #f44336;
}
button.cancel-btn:hover {
  background-color: #d32f2f;
}

/* 一括キャンセルボタン */
#cancelSelectedBtn {
  background-color: #c62828;
  font-weight: bold;
}
#cancelSelectedBtn:hover {
  background-color: #b71c1c;
}
    button:hover {
      background-color: #0277bd;
    }
    #logoutButton {
  margin-top: 10px;
  padding: 10px 20px;
  background-color: #ef5350;
  border-radius: 6px;
  border: none;
  color: white;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: background-color 0.3s, transform 0.2s;
}
#logoutButton:hover {
  background-color: #e53935;
  transform: scale(1.05);
}
    #adminInfo {
      margin-bottom: 10px;
    }
.tab-button {
  padding: 10px 20px;
  margin: 5px 8px;
  border: none;
  background-color: #b3e5fc;
  color: #0277bd;
  font-weight: bold;
  border-radius: 6px;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: background-color 0.3s, transform 0.2s;
}
.tab-button:hover {
  background-color: #81d4fa;
  transform: scale(1.05);
}
.tab-button.active {
  background-color: #0288d1;
  color: white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
.tab-content {
  margin-top: 20px;
}


#scheduleTable td.empty {
  color: #ccc;
}
    #scheduleTable td.empty:hover {
  background-color: #f0f0f0;
  cursor: pointer;
}
    #scheduleTable h3 {
  text-align: left;
  margin-top: 30px;
  font-size: 20px;
  color: #01579b;
  padding-left: 10px;
  border-left: 6px solid #0288d1;
  margin-bottom: 10px;
}
   #scheduleTable th:first-child,
#scheduleTable td:first-child {
  background-color: #e0f7fa;
  font-weight: bold;
  color: #006064;
}

#scheduleTable th:not(:first-child) {
  background-color: #e0f7fa;
  font-weight: bold;
  color: #006064;
}


#scheduleTable td.empty:hover {
  background-color: #f0f0f0;
  cursor: pointer;
}

    #scheduleTable td.empty {
  background-color: #ffffff;
  color: #ccc;
  border: 1px solid #bbb;
}
#scheduleTable td.empty:hover {
  background-color: #f0f0f0;
  cursor: pointer;
}

#scheduleTable td:not(.empty) {
  background-color: #fff3e0;
  font-weight: bold;
  color: #e65100;
  border: 1px solid #bbb;
}

#scheduleTable td.time-label {
  background-color: #e0f7fa;
  font-weight: bold;
  color: #006064;
  border: 1px solid #bbb;
}
  #hamburgerMenu {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 999;
}

#menuToggle {
  background-color: #0288d1;
  color: white;
  border: none;
  padding: 10px 14px;
  font-size: 18px;
  border-radius: 4px;
  cursor: pointer;
}

#sideMenu {
  position: fixed;
  top: 0;
  left: -250px;
  width: 240px;
  height: 100%;
  background-color: #e0f7fa;
  padding: 20px;
  box-shadow: 2px 0 6px rgba(0,0,0,0.2);
  transition: left 0.3s ease;
  z-index: 1000;
}

#sideMenu.visible {
  left: 0;
}

#sideMenu .menu-header {
  font-weight: bold;
  font-size: 18px;
  color: #006064;
  margin-bottom: 20px;
}

#sideMenu .menu-user {
  font-size: 14px;
  color: #333;
  margin-bottom: 20px;
}

#sideMenu button {
  display: block;
  width: 100%;
  margin: 10px 0;
  padding: 10px;
  background-color: #0288d1;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-align: left;
}

#sideMenu button:hover {
  background-color: #0277bd;
}  
    
    
  </style>
  
  <!-- flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

</head>
<body>

<!-- ▼ ハンバーガーメニュー本体 -->
<div id="hamburgerMenu">
  <button id="menuToggle">&#9776;</button> <!-- 三本線マーク -->

  <div id="sideMenu" class="hidden">
    <div class="menu-header">YHASN施設予約管理</div>
    <div class="menu-user">
      <div id="menuUserEmail">ログイン中</div>
    </div>
    <hr>
    <button onclick="location.href='admin-reserve.html'">教員用予約ページへ</button>
    <button id="logoutButtonSide">ログアウト</button>
  </div>
</div>

<h1>管理者用画面</h1>




<!-- h1のすぐ下に追加：常に表示される位置 -->
<div style="text-align: right; margin-bottom: 10px;">
  <button id="logoutButton">ログアウト</button>
</div>


<!-- タブ切り替えボタン -->
<div style="margin-bottom: 20px;">
  <button class="tab-button active" onclick="switchTab('reservationsTab')">予約情報一覧</button>
  <button class="tab-button" onclick="switchTab('emptyTab')">空室表</button>
</div>

<!-- 複数選択・一括キャンセルボタン -->
<div style="text-align: right; margin-bottom: 10px;">
  <button onclick="toggleMultiSelectMode()" id="multiSelectBtn">複数選択</button>
  <button onclick="cancelSelected()" id="cancelSelectedBtn" class="cancel-btn" style="display:none;">一括キャンセル</button>
</div>


<!-- ▼ これを追加：予約情報一覧タブ -->
<div id="reservationsTab" class="tab-content">
  <div id="adminInfo"></div>

<!-- ▼ 昇順・降順の切り替えボタン -->
<div style="text-align: right; margin-bottom: 10px;">
  <button onclick="changeSortOrder('asc')">昇順</button>
  <button onclick="changeSortOrder('desc')">降順</button>
</div>

<table id="reservationsTable">
    <thead>
      <tr>
        <th>日付</th>
        <th>時間</th>
        <th>部屋</th>
        <th>名前</th>
        <th>学籍番号</th>
        <th>学年</th>
        <th>メール</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="emptyTab" class="tab-content" style="display:none;">
  <div style="text-align: center; margin-bottom: 10px;">
    <button id="prevDayBtn">＜ 前の日</button>
    <input type="text" id="datePicker" readonly style="width: 150px; text-align:center;">
    <button id="nextDayBtn">次の日 ＞</button>
  </div>
  <div id="scheduleTable"></div>
</div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
  
function showLog(message) {
  const logArea = document.getElementById("debugLog");
  if (logArea) {
    const p = document.createElement("p");
    p.textContent = message;
    p.style.color = "red";
    p.style.fontSize = "14px";
    logArea.appendChild(p);
  }
}
    
    // Firebase 初期化
    const firebaseConfig = {
      apiKey: "AIzaSyCw6RzSw72t0BKoGjCONNPwz4plqn-74VY",
      authDomain: "yhasn-reserve.firebaseapp.com",
      projectId: "yhasn-reserve",
      storageBucket: "yhasn-reserve.appspot.com",
      messagingSenderId: "406712332925",
      appId: "1:406712332925:web:fb9253a313e4c76cfcb714"
    };
    // Firebase初期化
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ▼ 並べ替え制御用
let currentSortOrder = "asc";  // 初期は昇順

function changeSortOrder(order) {
  currentSortOrder = order;
  loadReservations(); // 並べ替え再実行
}

// ▼ 追記：複数選択モード制御用
let multiSelectMode = false;
let selectedIds = [];



firebase.auth().onAuthStateChanged(user => {
  const redirectedFromLogout = sessionStorage.getItem("justLoggedOut");

  if (!user) {
    if (!redirectedFromLogout) {
      alert("ログインしてください");
    }
    window.location.href = "admin-login.html";
  } else {
    sessionStorage.removeItem("justLoggedOut"); // ログイン状態なら不要
    document.getElementById("adminInfo").innerHTML = `
      <div style="color:#0277bd; font-weight:bold; font-size:15px;">
        ${user.email} でログイン中
      </div>
    `;
    loadReservations();
    setupFlatpickrAndButtons();
  }
});

function loadReservations() {
  console.log("✅ loadReservations 実行されたよ！");
  showLog("✅ loadReservations 実行された！");  // ←ここ追加

  const tbody = document.querySelector("#reservationsTable tbody");
  tbody.innerHTML = "";

  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  const todayStr = `${yyyy}-${mm}-${dd}`;

  db.collection("reservations")
  .where("date", ">=", todayStr)
	.orderBy("date", currentSortOrder)
	.orderBy("time", currentSortOrder)
	.orderBy("room", "asc")
	.orderBy("studentId", "asc")
	.orderBy("name", "asc")
	.orderBy("grade", "asc")
	.orderBy("email", "asc")
    .get()
    .then(snapshot => {
      showLog("📦 予約データ取得中...件数: " + snapshot.size); // ←ここ追加

      if (snapshot.empty) {
        tbody.innerHTML = "<tr><td colspan='8'>本日以降の予約はありません</td></tr>";
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        showLog("▶︎ " + JSON.stringify(data)); // ←ここ追加

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.date}</td>
          <td>${data.time}</td>
          <td>${data.room}</td>
          <td>${data.name}</td>
          <td>${data.studentId || ""}</td>
          <td>${data.grade || ""}</td>
          <td>${data.email}</td>
          <td>
            ${
              multiSelectMode
                ? `<input type="checkbox" class="multi-cancel-checkbox" data-id="${doc.id}" onchange="toggleSelect('${doc.id}', this.checked)">`
                : `<button class="cancel-btn" data-id="${doc.id}" onclick="cancelSingle('${doc.id}')">キャンセル</button>`
            }
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("reservationsTable").classList.remove("multi-mode");
      document.getElementById("cancelSelectedBtn").style.display = "none";

      tbody.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          if (confirm("この予約をキャンセルしますか？")) {
            db.collection("reservations").doc(id).delete().then(() => {
              alert("キャンセルしました");
              loadReservations();
            }).catch(err => {
              alert("キャンセルに失敗しました");
              console.error(err);
            });
          }
        });
      });
            // ▼ 追加：複数選択中ならキャンセルボタン表示
      if (multiSelectMode) {
        document.getElementById("cancelSelectedBtn").style.display = "inline-block";
      } else {
        document.getElementById("cancelSelectedBtn").style.display = "none";
      }
    })
    .catch(err => {
      showLog("❌ 読み込みエラー: " + err.message);  // ←ここ追加
      console.error("読み込みエラー:", err);
      tbody.innerHTML = "<tr><td colspan='8'>読み込みに失敗しました</td></tr>";
      document.body.innerHTML += `<p style="color:red;">読み込みエラー: ${err.message}</p>`;
    });
}

   document.getElementById("logoutButton").addEventListener("click", () => {
  sessionStorage.setItem("justLoggedOut", "1"); // ← ログアウト直後の判定用
  firebase.auth().signOut().then(() => {
    alert("ログアウトしました。画面遷移します");
    location.href = "admin-login.html";
  });
});
    
function switchTab(tabId) {
  document.querySelectorAll(".tab-content").forEach(div => div.style.display = "none");
  document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));

  document.getElementById(tabId).style.display = "block";
  
    // ▼ 追加：複数選択ボタンの表示切り替え
  const multiBtn = document.getElementById("multiSelectBtn");
  const cancelBtn = document.getElementById("cancelSelectedBtn");
  if (multiBtn && cancelBtn) {
    if (tabId === "reservationsTab") {
      multiBtn.style.display = "inline-block";
      if (multiSelectMode) {
        cancelBtn.style.display = "inline-block";
      }
    } else {
      multiBtn.style.display = "none";
      cancelBtn.style.display = "none";
    }
  }

  // 呼び出し元イベントが使えないので、class追加は tabId に応じて明示的に書く
  if (tabId === "reservationsTab") {
    document.querySelector("button[onclick*='reservationsTab']").classList.add("active");
  } else if (tabId === "emptyTab") {
    document.querySelector("button[onclick*='emptyTab']").classList.add("active");
  }

  if (tabId === "emptyTab") {
    const fp = document.getElementById("datePicker")._flatpickr;
    const selected = fp.selectedDates[0] || fp.latestSelectedDateObj || fp.parseDate(fp.input.value);
    if (selected) {
      currentDate = selected;
      loadSchedule(currentDate);
      updatePrevButtonVisibility(currentDate);
    }
  }
}

// 祝日リスト
const allHolidays = {
  "2025-01-01": "元日",
  "2025-01-13": "成人の日",
  "2025-02-11": "建国記念の日",
  "2025-02-23": "天皇誕生日",
  "2025-03-20": "春分の日",
  "2025-04-29": "昭和の日",
  "2025-05-03": "憲法記念日",
  "2025-05-04": "みどりの日",
  "2025-05-05": "こどもの日",
  "2025-05-06": "振替休日",
  "2025-07-21": "海の日",
  "2025-08-11": "山の日",
  "2025-09-15": "敬老の日",
  "2025-09-23": "秋分の日",
  "2025-10-13": "スポーツの日",
  "2025-11-03": "文化の日",
  "2025-11-23": "勤労感謝の日",
  "2025-12-23": "天皇誕生日"
};

let currentDate = getNextValidDate(new Date()); // ← グローバル日付管理用

function getNextValidDate(date, step = 0) {
  const next = new Date(date);
  next.setDate(next.getDate() + step);
  while (next.getDay() === 0 || next.getDay() === 6 || allHolidays[formatDate(next)]) {
    next.setDate(next.getDate() + (step >= 0 ? 1 : -1));
  }
  return next;
}

function formatDate(date) {
  const yyyy = date.getFullYear();
  const mm = String(date.getMonth() + 1).padStart(2, '0');
  const dd = String(date.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

function loadSchedule(date) {
  const scheduleTable = document.getElementById("scheduleTable");
  scheduleTable.innerHTML = "";

  const dateStr = formatDate(date);
  const timeSlots = ["08:30-09:00", "09:00-10:40（１限）", "10:40-12:10（２限）", "12:10-13:20（昼休み）", "13:20-15:00（３限）", "15:00-16:30（４限）", "16:30-18:00", "18:00-20:00"];
  const allRooms = [
    "学生演習室1", "学生演習室2", "学生演習室3", "学生演習室4", "学生演習室5",
    "交流室", "ベッド1", "ベッド2", "ベッド3", "ベッド4", "ベッド5", "ベッド6",
    "ベッド7", "ベッド8", "ベッド9", "ベッド10", "ベッド11", "ベッド12"
  ];

  db.collection("reservations")
    .where("date", "==", dateStr)
    .get()
    .then(snapshot => {
      const dataMap = {};
      snapshot.forEach(doc => {
        const data = doc.data();
        dataMap[`${data.time}_${data.room}`] = data;
      });

      function generateTable(rooms, title) {
        let html = `<h3>${title}</h3><table><thead><tr><th>時間帯</th>`;
        rooms.forEach(room => html += `<th>${room}</th>`);
        html += `</tr></thead><tbody>`;

        timeSlots.forEach(time => {
          html += `<tr><td class="time-label">${time}</td>`;
          rooms.forEach(room => {
            const key = `${time}_${room}`;
            const d = dataMap[key];
            if (d) {
             html += `<td>
  <div style="font-size: 12px; font-weight: bold;">${d.studentId || ""}</div>
  <div style="font-size: 13px;">${d.grade || ""}</div>
  <div style="font-size: 14px; font-weight: 600; color: #0277bd;">${d.name || ""}</div>
</td>`;
            } else {
           html += `<td class="empty" title="予約可能"><i class="fas fa-circle"></i></td>`;
            }
          });
          html += `</tr>`;
        });

        html += `</tbody></table><br>`;
        return html;
      }

      const group1 = allRooms.filter(r => r.includes("演習室") || r.includes("交流室"));
      const group2 = allRooms.filter(r => r.includes("ベッド"));

      scheduleTable.innerHTML =
        generateTable(group1, "学生演習室・交流室") +
        generateTable(group2, "ベッド（1〜12）");
    })
    .catch(err => {
      scheduleTable.innerHTML = `<p style="color:red;">読み込み失敗: ${err.message}</p>`;
    });
}

function setupFlatpickrAndButtons() {
  flatpickr("#datePicker", {
  locale: "ja",
  dateFormat: "Y-m-d",
  defaultDate: currentDate,
minDate: new Date(), // ← 土日祝に関係なく「今日」から選択可能
  disable: [
    function(date) {
      const day = date.getDay();
      const dateStr = formatDate(date);
      return day === 0 || day === 6 || allHolidays[dateStr];
    }
  ],
onChange: ([selectedDate]) => {
  if (selectedDate) {
    currentDate = selectedDate;
    loadSchedule(currentDate);
    updatePrevButtonVisibility(currentDate);
  }
},
 onReady: ([selectedDate]) => {
  currentDate = selectedDate || currentDate;
  loadSchedule(currentDate);
  updatePrevButtonVisibility(currentDate);
}
    
});
setTimeout(() => {
  const fp = document.getElementById("datePicker")._flatpickr;
  fp.setDate(currentDate, true);
fp.input.value = formatDate(currentDate); // ← これ追加！
}, 0);
document.getElementById("prevDayBtn").addEventListener("click", () => {
  const fp = document.getElementById("datePicker")._flatpickr;
  const newDate = getNextValidDate(currentDate, -1);
currentDate = newDate;
fp.setDate(newDate, true);
fp.input.value = formatDate(newDate); // ← これ追加！
loadSchedule(newDate);
updatePrevButtonVisibility(currentDate);
});

document.getElementById("nextDayBtn").addEventListener("click", () => {
  const fp = document.getElementById("datePicker")._flatpickr;
const newDate = getNextValidDate(currentDate, 1);
currentDate = newDate;
fp.setDate(newDate, true);
fp.input.value = formatDate(newDate); // ← これ追加！
loadSchedule(newDate);
updatePrevButtonVisibility(currentDate);
});


 
  function updatePrevButtonVisibility(selectedDate) {
  const today = new Date();
  today.setHours(0, 0, 0, 0); // 時間部分を無視するためクリア
  const selected = new Date(selectedDate);
  selected.setHours(0, 0, 0, 0);
  
  const isBeforeOrSame = selected <= today;
  document.getElementById("prevDayBtn").style.display = isBeforeOrSame ? "none" : "inline-block";
}
}
    // ▼ 一括キャンセル処理
document.getElementById("cancelSelectedBtn").addEventListener("click", () => {
  const checkboxes = document.querySelectorAll(".multi-cancel-checkbox:checked");
  if (checkboxes.length === 0) {
    alert("キャンセルする予約を選択してください。");
    return;
  }

  if (!confirm(`${checkboxes.length}件の予約を一括キャンセルしますか？`)) return;

  const idsToDelete = Array.from(checkboxes).map(cb => cb.dataset.id);
  let successCount = 0;
  let errorCount = 0;

  const promises = idsToDelete.map(id =>
    db.collection("reservations").doc(id).delete()
      .then(() => successCount++)
      .catch(() => errorCount++)
  );

  Promise.all(promises).then(() => {
    alert(`キャンセル完了：${successCount}件、失敗：${errorCount}件`);
    loadReservations(); // 再読み込み
  });
});
function toggleSelect(id, checked) {
  if (checked) {
    selectedIds.push(id);
  } else {
    selectedIds = selectedIds.filter(i => i !== id);
  }
}

function toggleMultiSelectMode() {
  multiSelectMode = !multiSelectMode;
  document.getElementById("cancelSelectedBtn").style.display = multiSelectMode ? "inline-block" : "none";
  loadReservations(); // ← これで表示をチェックボックスに切り替える
}

// ハンバーガーメニューの表示切り替え
document.getElementById("menuToggle").addEventListener("click", () => {
  const sideMenu = document.getElementById("sideMenu");
  sideMenu.classList.toggle("visible");
});

// メニュー内ログアウトボタン処理
document.getElementById("logoutButtonSide").addEventListener("click", () => {
  sessionStorage.setItem("justLoggedOut", "1");
  firebase.auth().signOut().then(() => {
    alert("ログアウトしました。画面遷移します");
    location.href = "admin-login.html";
  });
});

// Firebaseログイン後にメールアドレス表示
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    const emailDiv = document.getElementById("menuUserEmail");
    if (emailDiv) {
      emailDiv.textContent = `${user.email} でログイン中`;
    }
  }
});

  </script>
  <div id="debugLog" style="margin-top: 30px; padding: 10px; border: 2px dashed red;"></div>
</body>
</html>



