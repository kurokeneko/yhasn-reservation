<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>予約管理（管理者用）</title>
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
      margin: 30px;
      background-color: #f0f8ff;
    }
    h1 {
      color: #0277bd;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    button {
      padding: 6px 12px;
      background-color: #0288d1;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0277bd;
    }
    #adminInfo {
      margin-bottom: 10px;
    }
    .tab-button {
  padding: 8px 16px;
  margin-right: 10px;
  border: none;
  background-color: #b3e5fc;
  color: #0277bd;
  font-weight: bold;
  border-radius: 5px;
  cursor: pointer;
}
.tab-button.active {
  background-color: #0288d1;
  color: white;
}
.tab-content {
  margin-top: 20px;
}

    #scheduleTable table {
  width: 100%;
  border-collapse: collapse;
  background: #ffffff;
  margin-top: 10px;
}
#scheduleTable th, #scheduleTable td {
  border: 1px solid #ccc;
  padding: 10px;
  height: 60px;
  text-align: center;
  vertical-align: middle;
}
#scheduleTable td.empty {
  color: #ccc;
}
  </style>
  
  <!-- flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

</head>
<body>
<h1>管理者用画面</h1>

<div style="margin-bottom: 20px;">
  <button class="tab-button active" onclick="switchTab('reservationsTab')">予約情報一覧</button>
  <button class="tab-button" onclick="switchTab('emptyTab')">空室表</button>
</div>

<div id="reservationsTab" class="tab-content">
  <div id="adminInfo"></div>
  <button id="logoutButton">ログアウト</button>

  <table id="reservationsTable">
    <thead>
      <tr>
        <th>日付</th>
        <th>時間</th>
        <th>部屋</th>
        <th>名前</th>
        <th>学籍番号</th>
        <th>学年</th>
        <th>メール</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="emptyTab" class="tab-content" style="display:none;">
  <div style="text-align: center; margin-bottom: 10px;">
    <button id="prevDayBtn">＜ 前の日</button>
    <input type="text" id="datePicker" readonly style="width: 150px; text-align:center;">
    <button id="nextDayBtn">次の日 ＞</button>
  </div>
  <div id="scheduleTable"></div>
</div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    // Firebase 初期化
    const firebaseConfig = {
      apiKey: "AIzaSyCw6RzSw72t0BKoGjCONNPwz4plqn-74VY",
      authDomain: "yhasn-reserve.firebaseapp.com",
      projectId: "yhasn-reserve",
      storageBucket: "yhasn-reserve.appspot.com",
      messagingSenderId: "406712332925",
      appId: "1:406712332925:web:fb9253a313e4c76cfcb714"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 一時的にログイン不要で実行
    loadReservations();

    function loadReservations() {
  const tbody = document.querySelector("#reservationsTable tbody");
  tbody.innerHTML = "";

  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  const todayStr = `${yyyy}-${mm}-${dd}`;

  db.collection("reservations")
    .where("date", ">=", todayStr)
    .orderBy("date", "asc")
    .orderBy("time", "asc")
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        tbody.innerHTML = "<tr><td colspan='8'>本日以降の予約はありません</td></tr>";
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.date}</td>
          <td>${data.time}</td>
          <td>${data.room}</td>
          <td>${data.name}</td>
          <td>${data.studentId}</td>
          <td>${data.grade}</td>
          <td>${data.email}</td>
          <td><button data-id="${doc.id}">キャンセル</button></td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.id;
          if (confirm("この予約をキャンセルしますか？")) {
            db.collection("reservations").doc(id).delete().then(() => {
              alert("キャンセルしました");
              loadReservations();
            }).catch(err => {
              alert("キャンセルに失敗しました");
              console.error(err);
            });
          }
        });
      });
    })
    .catch(err => {
      console.error("読み込みエラー:", err);
      tbody.innerHTML = "<tr><td colspan='8'>読み込みに失敗しました</td></tr>";
      document.body.innerHTML += `<p style="color:red;">読み込みエラー: ${err.message}</p>`;
    });
}

    document.getElementById("logoutButton").addEventListener("click", () => {
      firebase.auth().signOut().then(() => {
        alert("ログアウトしました");
        location.href = "/";
      });
    });
    function switchTab(tabId) {
  document.querySelectorAll(".tab-content").forEach(div => div.style.display = "none");
  document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
  document.getElementById(tabId).style.display = "block";
  event.target.classList.add("active");
}
<!-- 祝日リスト -->
<script>
const allHolidays = {
  "2025-01-01": "元日",
  "2025-01-13": "成人の日",
  "2025-02-11": "建国記念の日",
  "2025-02-23": "天皇誕生日",
  "2025-03-20": "春分の日",
  "2025-04-29": "昭和の日",
  "2025-05-03": "憲法記念日",
  "2025-05-04": "みどりの日",
  "2025-05-05": "こどもの日",
  "2025-05-06": "振替休日",
  "2025-07-21": "海の日",
  "2025-08-11": "山の日",
  "2025-09-15": "敬老の日",
  "2025-09-23": "秋分の日",
  "2025-10-13": "スポーツの日",
  "2025-11-03": "文化の日",
  "2025-11-23": "勤労感謝の日",
  "2025-12-23": "天皇誕生日"
};

// flatpickr初期化
flatpickr("#datePicker", {
  locale: "ja",
  dateFormat: "Y-m-d",
  defaultDate: getNextValidDate(new Date()),
  onChange: ([selectedDate]) => {
    loadSchedule(selectedDate);
  }
});

// ボタンクリックで日付変更
document.getElementById("prevDayBtn").addEventListener("click", () => {
  const date = new Date(document.getElementById("datePicker").value);
  document.getElementById("datePicker")._flatpickr.setDate(getNextValidDate(date, -1));
});

document.getElementById("nextDayBtn").addEventListener("click", () => {
  const date = new Date(document.getElementById("datePicker").value);
  document.getElementById("datePicker")._flatpickr.setDate(getNextValidDate(date, 1));
});

function getNextValidDate(date, step = 0) {
  const next = new Date(date);
  next.setDate(next.getDate() + step);
  while (next.getDay() === 0 || next.getDay() === 6 || allHolidays[formatDate(next)]) {
    next.setDate(next.getDate() + (step >= 0 ? 1 : -1));
  }
  return next;
}

function formatDate(date) {
  const yyyy = date.getFullYear();
  const mm = String(date.getMonth() + 1).padStart(2, '0');
  const dd = String(date.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}

function loadSchedule(date) {
  const scheduleTable = document.getElementById("scheduleTable");
  scheduleTable.innerHTML = "";

  const dateStr = formatDate(date);
  const timeSlots = ["08:30-09:00", "09:00-10:40", "10:50-12:20", "13:00-14:30", "14:40-16:10", "16:20-17:50"];
  const rooms = [
    { name: "学生演習室1", beds: ["1", "2"] },
    { name: "学生演習室2", beds: ["3", "4"] },
    { name: "学生演習室3", beds: ["5", "6"] },
    { name: "学生演習室4", beds: ["7", "8"] },
    { name: "学生演習室5", beds: ["9", "10"] },
    { name: "交流室", beds: ["11", "12"] }
  ];

  db.collection("reservations")
    .where("date", "==", dateStr)
    .get()
    .then(snapshot => {
      const dataMap = {};
      snapshot.forEach(doc => {
        const data = doc.data();
        dataMap[`${data.time}_${data.room}`] = data;
      });

      let html = "";
      rooms.forEach(room => {
        html += `<h3>${room.name}</h3>`;
        html += `<table><thead><tr><th>時間帯</th>`;
        room.beds.forEach(b => {
          html += `<th>ベッド${b}</th>`;
        });
        html += `</tr></thead><tbody>`;
        timeSlots.forEach(time => {
          html += `<tr><td>${time}</td>`;
          room.beds.forEach(bed => {
            const key = `${time}_ベッド${bed}`;
            const d = dataMap[key];
            if (d) {
              html += `<td><div>${d.studentId || ""}</div><div>${d.grade || ""}</div><div>${d.name || ""}</div></td>`;
            } else {
              html += `<td class="empty">空き</td>`;
            }
          });
          html += `</tr>`;
        });
        html += `</tbody></table><br>`;
      });

      scheduleTable.innerHTML = html;
    })
    .catch(err => {
      scheduleTable.innerHTML = `<p style="color:red;">読み込み失敗: ${err.message}</p>`;
    });
}

// 初期表示
document.addEventListener("DOMContentLoaded", () => {
  const today = getNextValidDate(new Date());
  document.getElementById("datePicker")._flatpickr.setDate(today);
});
</script>
    
  </script>
</body>
</html>
